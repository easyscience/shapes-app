#######################
# ENVIRONMENT VARIABLES
#######################

# Platform-independent

[activation.env]
PYTHONIOENCODING = "utf-8"

# Platform-specific

# Ensures the main package is used from the source code during
# development, even if main package is installed in editable mode
# via uv. This is important because `pixi update` might replace
# the installed version with the latest released version.

# Unix/macOS
[target.unix.activation.env]
PYTHONPATH = "${PIXI_PROJECT_ROOT}/src${PYTHONPATH:+:${PYTHONPATH}}"
PATH = "$HOME/Qt/6.9.1/macos/bin${PATH:+:${PATH}}"

# Windows
[target.win.activation.env]
PYTHONPATH = "${PIXI_PROJECT_ROOT}/src;%PYTHONPATH%"

###########
# WORKSPACE
###########

[workspace]

# Supported platforms for the lock file (pixi.lock)
platforms = ['win-64', 'linux-64', 'osx-64', 'osx-arm64']

# Channels for fetching packages
channels = ['conda-forge']

##########
# FEATURES
##########

# Default feature configuration

[dependencies]
nodejs = '*' # Required for Prettier (non-Python formatting)
gsl = '*'    # GNU Scientific Library; required for pdffit2.

[pypi-dependencies] # == [feature.default.pypi-dependencies]
pip = '*'                                                          # Native package installer
easyshapes_app = { path = ".", editable = true, extras = ['dev'] }

# Specific features: Set specific Python versions

[feature.py-max.dependencies]
python = '3.13.*'

##############
# ENVIRONMENTS
##############

[environments]

# The `default` feature is always included in all environments.
# Additional features can be specified per environment.

# The `default` environment is always created and includes the `default` feature.
# It does not need to be specified explicitly unless non-default features are included.
default = { features = ['default', 'py-max'] }

#######
# TASKS
#######

[tasks]

##################
# üß™ Testing Tasks
##################

unit-tests = 'python -m pytest tests/unit/ --color=yes -v'
integration-tests = 'python -m pytest tests/integration/ --color=yes -n auto -v'
notebook-tests = 'python -m pytest --nbmake docs/docs/tutorials/ --nbmake-timeout=600 --color=yes -n auto -v'
script-tests = 'python -m pytest tools/test_scripts.py --color=yes -n auto -v'

test = { depends-on = ['unit-tests'] }

###########
# ‚úîÔ∏è Checks
###########

pyproject-check = 'python -m validate_pyproject pyproject.toml'
docs-format-check = 'docformatter --check src/ docs/docs/tutorials/'
notebook-format-check = 'nbqa ruff docs/docs/tutorials/'
py-lint-check = 'ruff check src/ tests/ docs/docs/tutorials/'
py-format-check = "ruff format --check src/ tests/ docs/docs/tutorials/"
nonpy-format-check = "npx prettier --list-different --config=prettierrc.toml --ignore-unknown ."
nonpy-format-check-modified = "python tools/nonpy_prettier_modified.py"

check = { depends-on = [
  'py-format-check',
  'docs-format-check',
  'py-lint-check',
  'nonpy-format-check-modified',
] }

##########
# üõ†Ô∏è Fixes
##########

docs-format-fix = 'docformatter --in-place src/ docs/docs/tutorials/'
notebook-format-fix = 'nbqa ruff --fix docs/docs/tutorials/'
py-lint-fix = 'ruff check --fix src/ tests/ docs/docs/tutorials/'
py-format-fix = "ruff format src/ tests/ docs/docs/tutorials/"
nonpy-format-fix = 'npx prettier --write --list-different --config=prettierrc.toml --ignore-unknown .'
nonpy-format-fix-modified = "python tools/nonpy_prettier_modified.py --write"
success-message-fix = 'echo "‚úÖ All code auto-formatting steps have been applied."'

fix = { depends-on = [
  'py-format-fix',
  'docs-format-fix',
  'py-lint-fix',
  'nonpy-format-fix-modified',
  'success-message-fix',
] }

####################
# üßÆ Code Complexity
####################

complexity-check = 'radon cc -s src/'
complexity-check-json = 'radon cc -s -j src/'
maintainability-check = 'radon mi src/'
maintainability-check-json = 'radon mi -j src/'
raw-metrics = 'radon raw -s src/'
raw-metrics-json = 'radon raw -s -j src/'

#############
# üìä Coverage
#############

unit-tests-coverage = 'pixi run unit-tests --cov=src/easyshapes_app --cov-report=term-missing'
integration-tests-coverage = 'pixi run integration-tests --cov=src/easyshapes_app --cov-report=term-missing'
docstring-coverage = 'interrogate -c pyproject.toml src/easyshapes_app'

cov = { depends-on = [
  'docstring-coverage',
  'unit-tests-coverage',
  'integration-tests-coverage',
] }

########################
# üìì Notebook Management
########################

notebook-convert = 'jupytext docs/docs/tutorials/*.py --from py:percent --to ipynb'
notebook-strip = 'nbstripout docs/docs/tutorials/*.ipynb'
notebook-tweak = 'python tools/tweak_notebooks.py tutorials/'
notebook-exec = 'python -m pytest --nbmake docs/docs/tutorials/ --nbmake-timeout=600 --overwrite --color=yes -n auto -v'

notebook-prepare = { depends-on = [
  #'notebook-convert',
  'notebook-strip',
  #'notebook-tweak',
] }

########################
# üìö Documentation Tasks
########################

docs-vars = "JUPYTER_PLATFORM_DIRS=1 PYTHONWARNINGS='ignore::RuntimeWarning'"
docs-pre = "pixi run docs-vars python -m mkdocs"
docs-serve = "pixi run docs-pre serve -f docs/mkdocs.yml"
docs-serve-dirty = "pixi run docs-serve --dirty"
docs-build = "pixi run docs-pre build -f docs/mkdocs.yml"
docs-build-local = "pixi run docs-build --no-directory-urls"

docs-deploy-pre = 'mike deploy -F docs/mkdocs.yml --push --branch gh-pages --update-aliases --alias-type redirect'
docs-set-default-pre = 'mike set-default -F docs/mkdocs.yml --push --branch gh-pages'

docs-update-assets = 'python tools/update_docs_assets.py'

##############################
# üì¶ Template Management Tasks
##############################

copier-copy = "copier copy gh:easyscience/templates . --data-file ../shapes/.copier-answers.yml --data template_type=app"
copier-recopy = "copier recopy --data-file ../shapes/.copier-answers.yml --data template_type=app"
copier-update = "copier update --data-file ../shapes/.copier-answers.yml --data template_type=app"

#####################
# ü™ù Pre-commit Hooks
#####################

# Pre-commit hook commands (to be used in .pre-commit-config.yaml)
py-lint-check-pre = 'ruff check'
py-format-check-pre = "ruff format --check"
nonpy-format-check-pre = "npx prettier --list-different --config=prettierrc.toml --ignore-unknown"
docs-format-check-pre = 'docformatter --check'

# Run like a real commit: staged files only (almost)
pre-commit-check = 'pre-commit run --hook-stage pre-commit'
# CI check: lint/format everything
pre-commit-check-all = 'pre-commit run --all-files --hook-stage pre-commit'
# Pre-push check: lint/format everything
pre-push-check = 'pre-commit run --all-files --hook-stage pre-push'

pre-commit-clean = 'pre-commit clean'
pre-commit-install = 'pre-commit install --hook-type pre-commit --hook-type pre-push --overwrite'
pre-commit-uninstall = 'pre-commit uninstall --hook-type pre-commit --hook-type pre-push'
pre-commit-setup = { depends-on = [
  'pre-commit-clean',
  'pre-commit-uninstall',
  'pre-commit-install',
] }

####################################
# üöÄ Other Development & Build Tasks
####################################

github-labels = 'python tools/update_github_labels.py'
freeze = 'pyinstaller src/easyshapes_app/main.py --name=easyshapes --log-level WARN --noconfirm --clean --windowed --onedir --add-data=src/easyshapes_app:. --collect-all EasyApp'

default-build = 'python -m build'
dist-build = 'python -m build --wheel --outdir dist'

npm-config = 'npm config set registry https://registry.npmjs.org/'
prettier-install = 'npm install --no-save --no-audit --no-fund prettier prettier-plugin-toml'

clean-pycache = "find . -type d -name '__pycache__' -prune -exec rm -rf '{}' +"
spdx-update = 'python tools/update_spdx.py'

post-install = { depends-on = [
  'npm-config',
  'prettier-install',
  'pre-commit-setup',
] }

##########################
# üîó Main Package Shortcut
##########################
easyshapes-py = 'python src/easyshapes_app/main.py'
easyshapes-qml = 'qml -I ../EasyApp/src/ -I src/easyshapes_app/ src/easyshapes_app/main.qml'
